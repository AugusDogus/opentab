name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

jobs:
  build-extension:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build extension
        working-directory: apps/extension
        run: bun run build
        env:
          PLASMO_PUBLIC_SERVER_URL: ${{ vars.PLASMO_PUBLIC_SERVER_URL }}

      - name: Create ZIP
        working-directory: apps/extension
        run: |
          cd build/chrome-mv2-prod
          zip -r ../../opentab-extension.zip .

      - name: Create CRX
        working-directory: apps/extension
        run: bunx crx3 pack build/chrome-mv2-prod -o opentab-extension.crx

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: extension
          path: |
            apps/extension/opentab-extension.zip
            apps/extension/opentab-extension.crx

  build-native:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build app
        working-directory: apps/native
        run: eas build --platform android --profile production --non-interactive --wait --json > build_result.json

      - name: Download build artifact
        working-directory: apps/native
        run: |
          ARTIFACT_URL=$(cat build_result.json | jq -r '.[0].artifacts.buildUrl')
          curl -L -o opentab.apk "$ARTIFACT_URL"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: native
          path: apps/native/opentab.apk

  release:
    needs: [build-extension, build-native]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create Release with Changelog
        run: bunx changelogithub
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Release Assets
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload ${{ github.ref_name }} \
            artifacts/extension/* \
            artifacts/native/* \
            --clobber
