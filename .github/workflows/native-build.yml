name: Build Native App

on:
    push:
        tags:
            - "v*"
    workflow_dispatch:
        inputs:
            platform:
                description: "Platform to build"
                required: true
                default: "android"
                type: choice
                options:
                    - android
                    - ios
            profile:
                description: "Build profile"
                required: true
                default: "production"
                type: choice
                options:
                    - preview
                    - production

jobs:
    build:
        runs-on: ubuntu-latest
        steps:
            - name: ðŸ— Setup repo
              uses: actions/checkout@v4

            - name: ðŸ— Setup Node
              uses: actions/setup-node@v4
              with:
                  node-version: 20.x

            - name: ðŸ— Setup Bun
              uses: oven-sh/setup-bun@v2
              with:
                  bun-version: latest

            - name: ðŸ— Setup EAS
              uses: expo/expo-github-action@v8
              with:
                  eas-version: latest
                  token: ${{ secrets.EXPO_TOKEN }}

            - name: ðŸ“¦ Install dependencies
              run: bun install --frozen-lockfile

            - name: ðŸš€ Build app
              id: build
              working-directory: apps/native
              run: |
                  if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
                    PLATFORM="${{ github.event.inputs.platform }}"
                    PROFILE="${{ github.event.inputs.profile }}"
                  else
                    PLATFORM="android"
                    PROFILE="production"
                  fi

                  echo "platform=$PLATFORM" >> $GITHUB_OUTPUT
                  echo "profile=$PROFILE" >> $GITHUB_OUTPUT

                  # Build and wait for completion, output JSON
                  eas build --platform $PLATFORM --profile $PROFILE --non-interactive --wait --json > build_result.json

                  # Extract build ID
                  BUILD_ID=$(cat build_result.json | jq -r '.[0].id')
                  echo "build_id=$BUILD_ID" >> $GITHUB_OUTPUT

            - name: ðŸ“¥ Download build artifact
              working-directory: apps/native
              run: |
                  # Get artifact URL from build result
                  ARTIFACT_URL=$(cat build_result.json | jq -r '.[0].artifacts.buildUrl')

                  if [ "${{ steps.build.outputs.platform }}" = "android" ]; then
                    curl -L -o opentab.apk "$ARTIFACT_URL"
                    echo "Downloaded APK"
                  else
                    curl -L -o opentab.ipa "$ARTIFACT_URL"
                    echo "Downloaded IPA"
                  fi

            - name: ðŸ“‹ Get version
              id: version
              run: |
                  if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
                    VERSION=$(cat apps/native/package.json | jq -r '.version')
                    echo "version=$VERSION" >> $GITHUB_OUTPUT
                  else
                    echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
                  fi

            - name: ðŸš€ Create Release
              if: github.event_name == 'push'
              uses: softprops/action-gh-release@v2
              with:
                  name: v${{ steps.version.outputs.version }}
                  files: |
                      apps/native/opentab.apk
                      apps/native/opentab.ipa
                  fail_on_unmatched_files: false
                  generate_release_notes: true
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: ðŸ“¤ Upload artifact (manual builds)
              if: github.event_name == 'workflow_dispatch'
              uses: actions/upload-artifact@v4
              with:
                  name: opentab-${{ steps.build.outputs.platform }}-${{ steps.version.outputs.version }}
                  path: |
                      apps/native/opentab.apk
                      apps/native/opentab.ipa
                  if-no-files-found: ignore
