diff --git a/dist/index.js b/dist/index.js
index ec005cd33333729572f35928d846fde85cb9ab01..4033f7baab7290df49c4e9b7a37670788ca9ebbb 100644
--- a/dist/index.js
+++ b/dist/index.js
@@ -108,7 +108,7 @@ declare module "@plasmohq/messaging" {
   interface PortsMetadata extends MpMetadata {}
 }
 `});import{readFile as Hd}from"fs/promises";import{resolve as Uc}from"path";import Gd from"json5";var Vr,jc,Jd,zd,qc,Wc=y(()=>{Vr=$(z(),1);Si();gi();jc=".plasmo/index.d.ts",Jd=[hi,vi].map(t=>`import "./${t}"`).join(`
-`),zd=async(t,e)=>{let r=Uc(t.projectDirectory,"tsconfig.json"),n=await Hd(r,"utf8"),i=Gd.parse(n),s=new Set(i.include);s.has(e)||(i.include=[e,...s],await(0,Vr.outputJson)(r,i,{spaces:2}))},qc=async t=>{let e=Uc(t.projectDirectory,jc);await Promise.all([(0,Vr.outputFile)(e,Jd),zd(t,jc)])}});import{lstat as Yd}from"fs/promises";import{resolve as Kd}from"path";async function Gr({dotPlasmoDirectory:t,cacheDirectory:e}){await(0,Hr.emptyDir)(t),await(0,Hr.ensureDir)(e)}async function Vc(t){let e=Kd(t.cacheDirectory,"parcel","data.mdb");if(!await A(e))return;let i=(await Yd(e,{bigint:!0})).size/1024n**2n,s=Number(i)/1024;s>1.47&&(d(`Busting large build cache, size: ${s.toFixed(2)} GB`),await Gr(t))}var Hr,bi=y(()=>{Hr=$(z(),1);X();k()});import Xd from"package-json";import Ei from"semver";async function Zd(t=""){switch((await lt()).name){case"npm":return`"npm i -S plasmo@${t}"`;case"pnpm":return`"pnpm i plasmo@${t}"`;case"yarn":return`"yarn add plasmo@${t}"`}}var Jr,Hc,kt,Qt=y(()=>{Jr=$(z(),1);X();k();bi();lr();Hc=async t=>{let{plasmoVersionFilePath:e}=t;if(!await A(e))d("Plasmo version file not found, busting cache..."),await Gr(t);else{let r=await(0,Jr.readJson)(e),n=Ei.coerce(r.version),i=Ei.coerce("0.90.5");(!n||n.major<i.major||n.major===i.major&&n.minor<i.minor)&&(d("Plasmo updated, busting cache..."),await Gr(t))}await(0,Jr.writeJson)(e,{version:"0.90.5"})},kt=async()=>{let t="0.90.5";try{let r=(await Xd("plasmo",{version:"latest"})).version;if(Ei.lt(t,r)){let{default:n}=await import("chalk");j(n.yellowBright(`A new version of plasmo is available: v${r}`));let i=await Zd(r);$i(n.yellow(`Run ${i} to update`))}}catch(e){le('Error fetching package information for "plasmo"',e)}}});var Qd,zr,Gc=y(()=>{k();Qd=t=>N({target:t}),zr=(t,e=Qd)=>{if(Array.isArray(t))return t.map(r=>zr(r,e)).filter(r=>r!==void 0);if(typeof t=="object"){let r={};for(let n in t)t.hasOwnProperty(n)&&(r[n]=zr(t[n],e),r[n]===void 0&&delete r[n]);return Object.keys(r).length===0?void 0:r}else return e(t)}});import{createHash as eh}from"crypto";var Yr,Pi=y(()=>{Yr=t=>eh("md5").update(t).digest("hex").slice(0,18)});import{resolve as Yc}from"path";import{cwd as th}from"process";import Jc from"semver";var Kc,rh,nh,ih,Xc,zc,sh,Zc,Qc,ki=y(()=>{Kc=$(z(),1);zt();X();Pe();rh=["react","svelte","vue","vanilla"],nh=[".tsx",".svelte",".vue",".jsx"],ih=new Set(nh),Xc=t=>ih.has(t),zc="No supported UI library found.  You can file an RFC for a new UI Library here: https://github.com/PlasmoHQ/plasmo/issues",sh=async t=>{if(t.includes(":")){let[e,r]=t.split(":");switch(e){case"file":default:let n=await(0,Kc.readJson)(Yc(th(),r,"package.json"));return Jc.coerce(n.version)?.major}}else return Jc.coerce(t)?.major},Zc=async t=>{let e=t.dependencies??{},r=rh.find(o=>o in e);if(r===void 0)return{name:"vanilla",path:"vanilla",version:8427};let n=await sh(e[r]);if(n===void 0)throw new Error(zc);if(r==="react"&&n<18)return{name:r,path:"react17",version:n};let i=`${r}${n}`,s=Yc(t.templatePath.staticTemplatePath,i);if(!await A(s))throw new Error(zc);return{name:r,path:i,version:n}},Qc=t=>{switch(t){case"svelte":return{uiExts:[".svelte"],mountExt:".ts"};case"vue":return{uiExts:[".vue"],mountExt:".ts"};case"react":return{uiExts:[".tsx",".jsx"],mountExt:".tsx"};case"vanilla":return{uiExts:[".tsx",".jsx"],mountExt:".ts"};default:bt(t)}}});import{readFile as el,writeFile as oh}from"fs/promises";import{join as Ci,relative as ah,resolve as xe}from"path";var Ct,Kr,tl=y(()=>{Ct=$(z(),1);Kt();X();k();Et();Pi();Pe();ki();Kr=class{constructor(e){this.plasmoManifest=e}#i={};#s={};get projectPath(){return this.plasmoManifest.projectPath}get commonPath(){return this.plasmoManifest.commonPath}get mountExt(){return this.plasmoManifest.mountExt}async init(){let[e,...r]=await Promise.all([this.#n(),this.#t("popup"),this.#t("options"),this.#t("newtab"),this.#t("devtools"),this.#t("sidepanel")]);return r}#n=async()=>{let e=xe(this.plasmoManifest.templatePath.staticTemplatePath,"common"),r=xe(this.commonPath.staticDirectory,"common");return(0,Ct.copy)(e,r)};#t=async e=>{d(`Creating static templates for ${e}`);let r=this.projectPath[`${e}IndexList`],n=this.projectPath[`${e}HtmlList`],[i,s]=await Promise.all([r,n].map(c=>Me(c,A))),{staticDirectory:o}=this.commonPath;await(0,Ct.ensureDir)(o);let a=i!==void 0,l=a?ce(ah(o,i)):`~${e}`,f=xe(o,`${e}${this.mountExt}`);return await Promise.all([this.#e(`index${this.mountExt}`,f,{__plasmo_import_module__:l}),this.createPageHtml(e,s)]),a};generateHtml=async(e="",r="",n="")=>{let i={__plasmo_static_index_title__:this.plasmoManifest.name,__plasmo_static_script__:r};return await ar(n)?this.#r(n,e,{...i,"</body>":`<div id="__plasmo"></div><script src="${r}" type="module"></script></body>`}):this.#e("index.html",e,i)};createPageHtml=async(e,r="")=>{let n=xe(this.commonPath.dotPlasmoDirectory,`${e}.html`),i=`./static/${e}${this.mountExt}`;return this.generateHtml(n,i,r)};createPageMount=async e=>{d(`Creating page mount template for ${e.dir}`);let r=xe(this.commonPath.dotPlasmoDirectory,e.dir),n=xe(r,`${e.name}.html`);await(0,Ct.ensureDir)(r);let i=Xc(e.ext),s=xe(r,`${e.name}${this.mountExt}`),o=xe(this.commonPath.sourceDirectory,e.dir,`${e.name}.html`),a=await Promise.all(i?[this.#e(`index${this.mountExt}`,s,{__plasmo_import_module__:`~${ce(Ci(e.dir,e.name))}`}),this.generateHtml(n,`./${e.name}${this.mountExt}`,o)]:[this.generateHtml(n,`~${ce(Ci(e.dir,e.name))}${e.ext}`,o)]);return{htmlPath:n,wereFilesWritten:a.some(l=>l)}};createContentScriptMount=async e=>{d(`Creating content script mount for ${e.dir}`);let r=xe(this.commonPath.staticDirectory,e.dir);await(0,Ct.ensureDir)(r);let n=xe(r,`${e.name}${this.mountExt}`);return await this.#e(`content-script-ui-mount${this.mountExt}`,n,{__plasmo_mount_content_script__:`~${ce(Ci(e.dir,e.name))}`}),n};#o=async(e,r,n)=>{let i=Object.entries(n).reduce((o,[a,l])=>o.replaceAll(a,l),e),s=Yr(Buffer.from(i));return this.#s[r]===s?!1:(this.#s[r]=s,await oh(r,i),!0)};#r=async(e,r,n)=>{let i=await el(e,"utf8");return this.#o(i,r,n)};#e=async(e,r,n)=>(this.#i[e]||=await el(xe(this.plasmoManifest.staticScaffoldPath,e),"utf8"),this.#o(this.#i[e],r,n))}});import{ok as De}from"assert";import{readdir as rl}from"fs/promises";import{basename as ch,dirname as lh,extname as nl,isAbsolute as fh,join as uh,parse as il,relative as Xr,resolve as Ye}from"path";import{cwd as ph}from"process";import mh from"fast-glob";import{hasher as dh}from"node-object-hash";var ie,er,hh,gh,Ot,Pe=y(()=>{ie=$(z(),1);oi();zt();pn();X();k();Et();Ur();gi();cr();Mc();wi();xi();Dn();Wc();bi();Qt();Gc();tl();ki();er={16:"./gen-assets/icon16.plasmo.png",32:"./gen-assets/icon32.plasmo.png",48:"./gen-assets/icon48.plasmo.png",64:"./gen-assets/icon64.plasmo.png",128:"./gen-assets/icon128.plasmo.png"},hh=["storage"],gh=dh({trim:!0,sort:!0}),Ot=class{constructor(e){this.bundleConfig=e;this.data.icons=er,this.scaffolder=new Kr(this)}get browser(){return this.bundleConfig.browser}#i;get commonPath(){return ai(this.#i)}#s;get projectPath(){return ai(this.#s)}templatePath=xr();#n;get combinedEnv(){return De(this.#n),this.#n.combinedEnv}get publicEnv(){return De(this.#n),this.#n.plasmoPublicEnv}#t=new Set([".ts",".js"]);#o=new Set;#r;get uiLibrary(){return De(this.#r),this.#r.uiLibrary}get mountExt(){return De(this.#r),this.#r.uiExtMap.mountExt}get uiExts(){return De(this.#r),this.#r.uiExtMap.uiExts}#e="";#a="";data={};overideManifest={};packageData;contentScriptMap=new Map;get mainWorldScriptList(){let e=[];for(let r of this.contentScriptMap.values())r.world==="MAIN"&&e.push(r);return e}get hasMainWorldScript(){for(let e of this.contentScriptMap.values())if(e.world==="MAIN")return!0;return!1}copyMap=new Map;permissionSet=new Set;scaffolder;get changed(){return this.#e!==this.#a}get name(){return De(this.packageData),this.packageData.displayName}get dependencies(){return De(this.packageData),this.packageData.dependencies??this.packageData.peerDependencies}get devDependencies(){return De(this.packageData),this.packageData.devDependencies}get staticScaffoldPath(){return De(this.uiLibrary),Ye(this.templatePath.staticTemplatePath,this.uiLibrary.path)}async initEnv(e=ph()){this.#n=await Oc(e),this.#i=ct(e)}async startup(){await this.initEnv(),d(`Ensure exists: ${this.commonPath.dotPlasmoDirectory}`),await(0,ie.ensureDir)(this.commonPath.dotPlasmoDirectory),await Vc(this.commonPath),await Hc(this.commonPath),await Wr(this.commonPath),await qc(this.commonPath),await this.updateEnv(),await this.updatePackageData()}async postBuild(){if(await Promise.all(Array.from(this.copyMap,async([n,i])=>{await or(n)||await(0,ie.copy)(i,n)})),!process.env.POST_BUILD_SCRIPT)return;let e=Ye(process.env.POST_BUILD_SCRIPT);if(!(0,ie.existsSync)(e)){j("Post-build script is unavailable:",e);return}v(e)()}async updateEnv(){await this.initEnv(this.commonPath.projectDirectory),await Nc(this)}prefixDev=(e="")=>process.env.NODE_ENV==="development"?`DEV | ${e}`:e;async updatePackageData(){if(this.packageData=await(0,ie.readJson)(this.commonPath.packageFilePath),!this.packageData)throw new Error("Invalid package.json");this.data.version=this.packageData.version,this.data.author=this.packageData.author,this.data.name=this.prefixDev(this.packageData.displayName),this.data.description=this.packageData.description,this.packageData.homepage&&(this.data.homepage_url=this.packageData.homepage);for(let e of hh)`@plasmohq/${e}`in(this.packageData.dependencies||{})&&this.permissionSet.add(e);await this.#c(),this.overideManifest=await this.#l()}#c=async()=>{let e=await Zc(this),r=Qc(e.name);this.#r={uiLibrary:e,uiExtMap:r},this.#o=new Set(r.uiExts),this.uiExts.forEach(n=>{this.#t.add(n)}),this.#s=Ac(this.commonPath,this.browser,this.uiExts)};toggleOptions=(e=!1)=>(e?this.data.options_ui={page:"./options.html",open_in_tab:!0}:delete this.data.options_ui,this);toggleOverrides=(e,r=!1)=>(r?this.data.chrome_url_overrides={...this.data.chrome_url_overrides,[e]:`./${e}.html`}:delete this.data.chrome_url_overrides?.[e],this);toggleNewtab=(e=!1)=>this.toggleOverrides("newtab",e);toggleDevtools=(e=!1)=>(e?this.data.devtools_page="./devtools.html":delete this.data.devtools_page,this);isPathInvalid=e=>{if(e===void 0)return!0;let r=nl(e);if(!this.#t.has(r))return!0;let n=Ec(e);return!!(n.length>0&&n!==`.${this.browser}`||n.length===0&&(0,ie.existsSync)(e.replace(r,`.${this.browser}${r}`)))};toggleContentScript=async(e,r=!1)=>{if(this.isPathInvalid(e))return!1;if(r){let n=await Ic(e);if(n?.isEmpty)return!1;d("Adding content script: ",e);let i=Xr(this.commonPath.dotPlasmoDirectory,e),s=nl(i),o=this.#o.has(s);if(this.uiLibrary?.name!=="vanilla"&&o){let l=uh("lab",i).replace(/(^src)[\\/]/,""),f=il(l);i=Xr(this.commonPath.dotPlasmoDirectory,await this.scaffolder.createContentScriptMount(f))}n?.config?.css&&n.config.css.length>0&&(n.config.css=n.config.css.map(l=>Xr(this.commonPath.dotPlasmoDirectory,Ye(lh(e),l))));let a=this.injectEnvToObj({matches:["<all_urls>"],js:[n?.config?.world==="MAIN"?i.split(s)[0]:i],...n?.config||{}});this.contentScriptMap.set(e,a)}else this.contentScriptMap.delete(e);return mc("cs_changed"),r};addDirectory=async(e,r,n)=>(0,ie.existsSync)(e)?rl(e,{withFileTypes:!0}).then(i=>Promise.all(i.filter(s=>s.isFile()&&n?n(s.name):!0).map(s=>Ye(e,s.name)).map(s=>r(s,!0)))).then(i=>i.includes(!0)):!1;addContentScriptsIndexFiles=async()=>{let e=this.projectPath.contentsDirectory;if(!await Hi(e))return!1;let r=[...this.#t].flatMap(n=>[`index${n}`,`index.${this.browser}${n}`]);return rl(e,{withFileTypes:!0}).then(n=>Promise.all(n.filter(i=>i.isDirectory()).map(i=>Ye(e,i.name)).map(i=>this.addDirectory(i,this.toggleContentScript,s=>r.includes(s))))).then(n=>n.includes(!0))};addContentScriptsDirectory=async(e=this.projectPath.contentsDirectory)=>Promise.all([this.addDirectory(e,this.toggleContentScript),this.addContentScriptsIndexFiles()]).then(r=>r.includes(!0));togglePage=async(e,r=!1)=>{if(this.isPathInvalid(e))return!1;if(r){let n=Xr(this.commonPath.sourceDirectory,e),i=il(n),{wereFilesWritten:s}=await this.scaffolder.createPageMount(i);s&&(this.#e="")}else this.#e="";return r};addPagesDirectory=async e=>this.addDirectory(e,this.togglePage);write=(e=!1)=>{this.#a=this.#e;let r=this.toJSON();if(this.#e=gh.hash(r),!(!this.changed&&!e))return d("Hash changed, updating manifest"),(0,ie.writeJson)(this.commonPath.entryManifestPath,r,{spaces:2})};toJSON=()=>{let e={...this.data},{options_ui:r,permissions:n,content_scripts:i,background:s,...o}=this.overideManifest;return e.options_ui?.page&&(e.options_ui={...e.options_ui,...r}),e.permissions=[...new Set([...this.permissionSet,...n||[]])],e.permissions?.length===0&&delete e.permissions,this.bundleConfig.manifestVersion==="mv2"&&(e.background={...e.background,...s},Object.keys(e.background).length===0&&delete e.background,o.host_permissions?.length>0&&(e.permissions=[...e.permissions||[],...o.host_permissions])),e.content_scripts=[...Array.from(this.contentScriptMap.values()).filter(a=>a.world!=="MAIN"),...i||[]],e.content_scripts.length===0&&delete e.content_scripts,{...e,...o}};#l=async()=>{if(!this.packageData?.manifest)return{};let e=await this.prepareOverrideManifest();if((e.web_accessible_resources?.length||0)>0&&(e.web_accessible_resources=await this.resolveWAR(this.packageData.manifest.web_accessible_resources)),e.browser_specific_settings)switch(this.browser){case"edge":case"safari":e.browser_specific_settings={[this.browser]:e.browser_specific_settings[this.browser]};break;case"firefox":case"gecko":e.browser_specific_settings={gecko:e.browser_specific_settings.gecko};break;default:delete e.browser_specific_settings}return e.overrides&&e.overrides[this.browser]&&(e={...e,...e.overrides[this.browser]}),delete e.overrides,this.injectEnvToObj(e)};copyProjectFile=async e=>{try{if(e.startsWith("~"))return this.copyProjectFile(e.slice(1));if(e.includes("*")){let s=await mh(e,{cwd:this.commonPath.projectDirectory,onlyFiles:!0});return await Promise.all(s.map(this.copyProjectFile)),e}let r=fh(e)?e:Ye(this.commonPath.projectDirectory,e);if(!(!this.projectPath.isEntryPath(r)&&await(0,ie.pathExists)(r)))return e;let i=Ye(this.commonPath.distDirectory,e);return this.copyMap.set(i,r),ce(e)}catch{return e}};copyNodeModuleFile=async e=>{try{let r=v.resolve(e,{paths:[this.commonPath.projectDirectory]}),n=ch(r),i=Ye(this.commonPath.distDirectory,n);return this.copyMap.set(i,r),n}catch{return null}};injectEnvToObj=e=>zr(e,r=>typeof r!="string"?r:r.match(/^\$(\w+)$/)?this.combinedEnv[r.substring(1)]||void 0:Fi(r,this.combinedEnv))}});import{relative as yh,resolve as sl}from"path";var Zr,ol,al=y(()=>{Zr=$(z(),1);k();Et();Pe();ol=async({indexFilePath:t="",withMessaging:e=!1,withMainWorldScript:r=!1},n)=>{d("Creating BGSW entry");let i=sl(n.commonPath.staticDirectory,"background"),s=sl(i,"index.ts"),o=yh(i,t),a=[e&&'import "./messaging"',t&&`import "${ce(o).slice(0,-3)}"`,r&&'import "./main-world-scripts"'].filter(Boolean).join(`
+`),zd=async(t,e)=>{let r=Uc(t.projectDirectory,"tsconfig.json"),n=await Hd(r,"utf8"),i=Gd.parse(n),s=new Set(i.include);s.has(e)||(i.include=[e,...s],await(0,Vr.outputJson)(r,i,{spaces:2}))},qc=async t=>{let e=Uc(t.projectDirectory,jc);await Promise.all([(0,Vr.outputFile)(e,Jd),zd(t,jc)])}});import{lstat as Yd}from"fs/promises";import{resolve as Kd}from"path";async function Gr({dotPlasmoDirectory:t,cacheDirectory:e}){await(0,Hr.emptyDir)(t),await(0,Hr.ensureDir)(e)}async function Vc(t){let e=Kd(t.cacheDirectory,"parcel","data.mdb");if(!await A(e))return;let i=(await Yd(e,{bigint:!0})).size/1024n**2n,s=Number(i)/1024;s>1.47&&(d(`Busting large build cache, size: ${s.toFixed(2)} GB`),await Gr(t))}var Hr,bi=y(()=>{Hr=$(z(),1);X();k()});import Xd from"package-json";import Ei from"semver";async function Zd(t=""){switch((await lt()).name){case"npm":return`"npm i -S plasmo@${t}"`;case"pnpm":return`"pnpm i plasmo@${t}"`;case"yarn":return`"yarn add plasmo@${t}"`}}var Jr,Hc,kt,Qt=y(()=>{Jr=$(z(),1);X();k();bi();lr();Hc=async t=>{let{plasmoVersionFilePath:e}=t;if(!await A(e))d("Plasmo version file not found, busting cache..."),await Gr(t);else{let r=await(0,Jr.readJson)(e),n=Ei.coerce(r.version),i=Ei.coerce("0.90.5");(!n||n.major<i.major||n.major===i.major&&n.minor<i.minor)&&(d("Plasmo updated, busting cache..."),await Gr(t))}await(0,Jr.writeJson)(e,{version:"0.90.5"})},kt=async()=>{let t="0.90.5";try{let r=(await Xd("plasmo",{version:"latest"})).version;if(Ei.lt(t,r)){let{default:n}=await import("chalk");j(n.yellowBright(`A new version of plasmo is available: v${r}`));let i=await Zd(r);$i(n.yellow(`Run ${i} to update`))}}catch(e){le('Error fetching package information for "plasmo"',e)}}});var Qd,zr,Gc=y(()=>{k();Qd=t=>N({target:t}),zr=(t,e=Qd)=>{if(Array.isArray(t))return t.map(r=>zr(r,e)).filter(r=>r!==void 0);if(typeof t=="object"){let r={};for(let n in t)t.hasOwnProperty(n)&&(r[n]=zr(t[n],e),r[n]===void 0&&delete r[n]);return Object.keys(r).length===0?void 0:r}else return e(t)}});import{createHash as eh}from"crypto";var Yr,Pi=y(()=>{Yr=t=>eh("md5").update(t).digest("hex").slice(0,18)});import{resolve as Yc}from"path";import{cwd as th}from"process";import Jc from"semver";var Kc,rh,nh,ih,Xc,zc,sh,Zc,Qc,ki=y(()=>{Kc=$(z(),1);zt();X();Pe();rh=["react","svelte","vue","vanilla"],nh=[".tsx",".svelte",".vue",".jsx"],ih=new Set(nh),Xc=t=>ih.has(t),zc="No supported UI library found.  You can file an RFC for a new UI Library here: https://github.com/PlasmoHQ/plasmo/issues",sh=async(t,e)=>{if(t.includes(":")){let[r,n]=t.split(":");switch(r){case"catalog":case"workspace":if(e){try{let o=v.resolve(e,{paths:[th()]});let a=await(0,Kc.readJson)(Yc(o,"..","package.json"));return Jc.coerce(a.version)?.major}catch{return}}return;case"file":default:let i=await(0,Kc.readJson)(Yc(th(),n,"package.json"));return Jc.coerce(i.version)?.major}}else return Jc.coerce(t)?.major},Zc=async t=>{let e=t.dependencies??{},r=rh.find(o=>o in e);if(r===void 0)return{name:"vanilla",path:"vanilla",version:8427};let n=await sh(e[r],r);if(n===void 0)throw new Error(zc);if(r==="react"&&n<18)return{name:r,path:"react17",version:n};let i=`${r}${n}`,s=Yc(t.templatePath.staticTemplatePath,i);if(!await A(s))throw new Error(zc);return{name:r,path:i,version:n}},Qc=t=>{switch(t){case"svelte":return{uiExts:[".svelte"],mountExt:".ts"};case"vue":return{uiExts:[".vue"],mountExt:".ts"};case"react":return{uiExts:[".tsx",".jsx"],mountExt:".tsx"};case"vanilla":return{uiExts:[".tsx",".jsx"],mountExt:".ts"};default:bt(t)}}});import{readFile as el,writeFile as oh}from"fs/promises";import{join as Ci,relative as ah,resolve as xe}from"path";var Ct,Kr,tl=y(()=>{Ct=$(z(),1);Kt();X();k();Et();Pi();Pe();ki();Kr=class{constructor(e){this.plasmoManifest=e}#i={};#s={};get projectPath(){return this.plasmoManifest.projectPath}get commonPath(){return this.plasmoManifest.commonPath}get mountExt(){return this.plasmoManifest.mountExt}async init(){let[e,...r]=await Promise.all([this.#n(),this.#t("popup"),this.#t("options"),this.#t("newtab"),this.#t("devtools"),this.#t("sidepanel")]);return r}#n=async()=>{let e=xe(this.plasmoManifest.templatePath.staticTemplatePath,"common"),r=xe(this.commonPath.staticDirectory,"common");return(0,Ct.copy)(e,r)};#t=async e=>{d(`Creating static templates for ${e}`);let r=this.projectPath[`${e}IndexList`],n=this.projectPath[`${e}HtmlList`],[i,s]=await Promise.all([r,n].map(c=>Me(c,A))),{staticDirectory:o}=this.commonPath;await(0,Ct.ensureDir)(o);let a=i!==void 0,l=a?ce(ah(o,i)):`~${e}`,f=xe(o,`${e}${this.mountExt}`);return await Promise.all([this.#e(`index${this.mountExt}`,f,{__plasmo_import_module__:l}),this.createPageHtml(e,s)]),a};generateHtml=async(e="",r="",n="")=>{let i={__plasmo_static_index_title__:this.plasmoManifest.name,__plasmo_static_script__:r};return await ar(n)?this.#r(n,e,{...i,"</body>":`<div id="__plasmo"></div><script src="${r}" type="module"></script></body>`}):this.#e("index.html",e,i)};createPageHtml=async(e,r="")=>{let n=xe(this.commonPath.dotPlasmoDirectory,`${e}.html`),i=`./static/${e}${this.mountExt}`;return this.generateHtml(n,i,r)};createPageMount=async e=>{d(`Creating page mount template for ${e.dir}`);let r=xe(this.commonPath.dotPlasmoDirectory,e.dir),n=xe(r,`${e.name}.html`);await(0,Ct.ensureDir)(r);let i=Xc(e.ext),s=xe(r,`${e.name}${this.mountExt}`),o=xe(this.commonPath.sourceDirectory,e.dir,`${e.name}.html`),a=await Promise.all(i?[this.#e(`index${this.mountExt}`,s,{__plasmo_import_module__:`~${ce(Ci(e.dir,e.name))}`}),this.generateHtml(n,`./${e.name}${this.mountExt}`,o)]:[this.generateHtml(n,`~${ce(Ci(e.dir,e.name))}${e.ext}`,o)]);return{htmlPath:n,wereFilesWritten:a.some(l=>l)}};createContentScriptMount=async e=>{d(`Creating content script mount for ${e.dir}`);let r=xe(this.commonPath.staticDirectory,e.dir);await(0,Ct.ensureDir)(r);let n=xe(r,`${e.name}${this.mountExt}`);return await this.#e(`content-script-ui-mount${this.mountExt}`,n,{__plasmo_mount_content_script__:`~${ce(Ci(e.dir,e.name))}`}),n};#o=async(e,r,n)=>{let i=Object.entries(n).reduce((o,[a,l])=>o.replaceAll(a,l),e),s=Yr(Buffer.from(i));return this.#s[r]===s?!1:(this.#s[r]=s,await oh(r,i),!0)};#r=async(e,r,n)=>{let i=await el(e,"utf8");return this.#o(i,r,n)};#e=async(e,r,n)=>(this.#i[e]||=await el(xe(this.plasmoManifest.staticScaffoldPath,e),"utf8"),this.#o(this.#i[e],r,n))}});import{ok as De}from"assert";import{readdir as rl}from"fs/promises";import{basename as ch,dirname as lh,extname as nl,isAbsolute as fh,join as uh,parse as il,relative as Xr,resolve as Ye}from"path";import{cwd as ph}from"process";import mh from"fast-glob";import{hasher as dh}from"node-object-hash";var ie,er,hh,gh,Ot,Pe=y(()=>{ie=$(z(),1);oi();zt();pn();X();k();Et();Ur();gi();cr();Mc();wi();xi();Dn();Wc();bi();Qt();Gc();tl();ki();er={16:"./gen-assets/icon16.plasmo.png",32:"./gen-assets/icon32.plasmo.png",48:"./gen-assets/icon48.plasmo.png",64:"./gen-assets/icon64.plasmo.png",128:"./gen-assets/icon128.plasmo.png"},hh=["storage"],gh=dh({trim:!0,sort:!0}),Ot=class{constructor(e){this.bundleConfig=e;this.data.icons=er,this.scaffolder=new Kr(this)}get browser(){return this.bundleConfig.browser}#i;get commonPath(){return ai(this.#i)}#s;get projectPath(){return ai(this.#s)}templatePath=xr();#n;get combinedEnv(){return De(this.#n),this.#n.combinedEnv}get publicEnv(){return De(this.#n),this.#n.plasmoPublicEnv}#t=new Set([".ts",".js"]);#o=new Set;#r;get uiLibrary(){return De(this.#r),this.#r.uiLibrary}get mountExt(){return De(this.#r),this.#r.uiExtMap.mountExt}get uiExts(){return De(this.#r),this.#r.uiExtMap.uiExts}#e="";#a="";data={};overideManifest={};packageData;contentScriptMap=new Map;get mainWorldScriptList(){let e=[];for(let r of this.contentScriptMap.values())r.world==="MAIN"&&e.push(r);return e}get hasMainWorldScript(){for(let e of this.contentScriptMap.values())if(e.world==="MAIN")return!0;return!1}copyMap=new Map;permissionSet=new Set;scaffolder;get changed(){return this.#e!==this.#a}get name(){return De(this.packageData),this.packageData.displayName}get dependencies(){return De(this.packageData),this.packageData.dependencies??this.packageData.peerDependencies}get devDependencies(){return De(this.packageData),this.packageData.devDependencies}get staticScaffoldPath(){return De(this.uiLibrary),Ye(this.templatePath.staticTemplatePath,this.uiLibrary.path)}async initEnv(e=ph()){this.#n=await Oc(e),this.#i=ct(e)}async startup(){await this.initEnv(),d(`Ensure exists: ${this.commonPath.dotPlasmoDirectory}`),await(0,ie.ensureDir)(this.commonPath.dotPlasmoDirectory),await Vc(this.commonPath),await Hc(this.commonPath),await Wr(this.commonPath),await qc(this.commonPath),await this.updateEnv(),await this.updatePackageData()}async postBuild(){if(await Promise.all(Array.from(this.copyMap,async([n,i])=>{await or(n)||await(0,ie.copy)(i,n)})),!process.env.POST_BUILD_SCRIPT)return;let e=Ye(process.env.POST_BUILD_SCRIPT);if(!(0,ie.existsSync)(e)){j("Post-build script is unavailable:",e);return}v(e)()}async updateEnv(){await this.initEnv(this.commonPath.projectDirectory),await Nc(this)}prefixDev=(e="")=>process.env.NODE_ENV==="development"?`DEV | ${e}`:e;async updatePackageData(){if(this.packageData=await(0,ie.readJson)(this.commonPath.packageFilePath),!this.packageData)throw new Error("Invalid package.json");this.data.version=this.packageData.version,this.data.author=this.packageData.author,this.data.name=this.prefixDev(this.packageData.displayName),this.data.description=this.packageData.description,this.packageData.homepage&&(this.data.homepage_url=this.packageData.homepage);for(let e of hh)`@plasmohq/${e}`in(this.packageData.dependencies||{})&&this.permissionSet.add(e);await this.#c(),this.overideManifest=await this.#l()}#c=async()=>{let e=await Zc(this),r=Qc(e.name);this.#r={uiLibrary:e,uiExtMap:r},this.#o=new Set(r.uiExts),this.uiExts.forEach(n=>{this.#t.add(n)}),this.#s=Ac(this.commonPath,this.browser,this.uiExts)};toggleOptions=(e=!1)=>(e?this.data.options_ui={page:"./options.html",open_in_tab:!0}:delete this.data.options_ui,this);toggleOverrides=(e,r=!1)=>(r?this.data.chrome_url_overrides={...this.data.chrome_url_overrides,[e]:`./${e}.html`}:delete this.data.chrome_url_overrides?.[e],this);toggleNewtab=(e=!1)=>this.toggleOverrides("newtab",e);toggleDevtools=(e=!1)=>(e?this.data.devtools_page="./devtools.html":delete this.data.devtools_page,this);isPathInvalid=e=>{if(e===void 0)return!0;let r=nl(e);if(!this.#t.has(r))return!0;let n=Ec(e);return!!(n.length>0&&n!==`.${this.browser}`||n.length===0&&(0,ie.existsSync)(e.replace(r,`.${this.browser}${r}`)))};toggleContentScript=async(e,r=!1)=>{if(this.isPathInvalid(e))return!1;if(r){let n=await Ic(e);if(n?.isEmpty)return!1;d("Adding content script: ",e);let i=Xr(this.commonPath.dotPlasmoDirectory,e),s=nl(i),o=this.#o.has(s);if(this.uiLibrary?.name!=="vanilla"&&o){let l=uh("lab",i).replace(/(^src)[\\/]/,""),f=il(l);i=Xr(this.commonPath.dotPlasmoDirectory,await this.scaffolder.createContentScriptMount(f))}n?.config?.css&&n.config.css.length>0&&(n.config.css=n.config.css.map(l=>Xr(this.commonPath.dotPlasmoDirectory,Ye(lh(e),l))));let a=this.injectEnvToObj({matches:["<all_urls>"],js:[n?.config?.world==="MAIN"?i.split(s)[0]:i],...n?.config||{}});this.contentScriptMap.set(e,a)}else this.contentScriptMap.delete(e);return mc("cs_changed"),r};addDirectory=async(e,r,n)=>(0,ie.existsSync)(e)?rl(e,{withFileTypes:!0}).then(i=>Promise.all(i.filter(s=>s.isFile()&&n?n(s.name):!0).map(s=>Ye(e,s.name)).map(s=>r(s,!0)))).then(i=>i.includes(!0)):!1;addContentScriptsIndexFiles=async()=>{let e=this.projectPath.contentsDirectory;if(!await Hi(e))return!1;let r=[...this.#t].flatMap(n=>[`index${n}`,`index.${this.browser}${n}`]);return rl(e,{withFileTypes:!0}).then(n=>Promise.all(n.filter(i=>i.isDirectory()).map(i=>Ye(e,i.name)).map(i=>this.addDirectory(i,this.toggleContentScript,s=>r.includes(s))))).then(n=>n.includes(!0))};addContentScriptsDirectory=async(e=this.projectPath.contentsDirectory)=>Promise.all([this.addDirectory(e,this.toggleContentScript),this.addContentScriptsIndexFiles()]).then(r=>r.includes(!0));togglePage=async(e,r=!1)=>{if(this.isPathInvalid(e))return!1;if(r){let n=Xr(this.commonPath.sourceDirectory,e),i=il(n),{wereFilesWritten:s}=await this.scaffolder.createPageMount(i);s&&(this.#e="")}else this.#e="";return r};addPagesDirectory=async e=>this.addDirectory(e,this.togglePage);write=(e=!1)=>{this.#a=this.#e;let r=this.toJSON();if(this.#e=gh.hash(r),!(!this.changed&&!e))return d("Hash changed, updating manifest"),(0,ie.writeJson)(this.commonPath.entryManifestPath,r,{spaces:2})};toJSON=()=>{let e={...this.data},{options_ui:r,permissions:n,content_scripts:i,background:s,...o}=this.overideManifest;return e.options_ui?.page&&(e.options_ui={...e.options_ui,...r}),e.permissions=[...new Set([...this.permissionSet,...n||[]])],e.permissions?.length===0&&delete e.permissions,this.bundleConfig.manifestVersion==="mv2"&&(e.background={...e.background,...s},Object.keys(e.background).length===0&&delete e.background,o.host_permissions?.length>0&&(e.permissions=[...e.permissions||[],...o.host_permissions])),e.content_scripts=[...Array.from(this.contentScriptMap.values()).filter(a=>a.world!=="MAIN"),...i||[]],e.content_scripts.length===0&&delete e.content_scripts,{...e,...o}};#l=async()=>{if(!this.packageData?.manifest)return{};let e=await this.prepareOverrideManifest();if((e.web_accessible_resources?.length||0)>0&&(e.web_accessible_resources=await this.resolveWAR(this.packageData.manifest.web_accessible_resources)),e.browser_specific_settings)switch(this.browser){case"edge":case"safari":e.browser_specific_settings={[this.browser]:e.browser_specific_settings[this.browser]};break;case"firefox":case"gecko":e.browser_specific_settings={gecko:e.browser_specific_settings.gecko};break;default:delete e.browser_specific_settings}return e.overrides&&e.overrides[this.browser]&&(e={...e,...e.overrides[this.browser]}),delete e.overrides,this.injectEnvToObj(e)};copyProjectFile=async e=>{try{if(e.startsWith("~"))return this.copyProjectFile(e.slice(1));if(e.includes("*")){let s=await mh(e,{cwd:this.commonPath.projectDirectory,onlyFiles:!0});return await Promise.all(s.map(this.copyProjectFile)),e}let r=fh(e)?e:Ye(this.commonPath.projectDirectory,e);if(!(!this.projectPath.isEntryPath(r)&&await(0,ie.pathExists)(r)))return e;let i=Ye(this.commonPath.distDirectory,e);return this.copyMap.set(i,r),ce(e)}catch{return e}};copyNodeModuleFile=async e=>{try{let r=v.resolve(e,{paths:[this.commonPath.projectDirectory]}),n=ch(r),i=Ye(this.commonPath.distDirectory,n);return this.copyMap.set(i,r),n}catch{return null}};injectEnvToObj=e=>zr(e,r=>typeof r!="string"?r:r.match(/^\$(\w+)$/)?this.combinedEnv[r.substring(1)]||void 0:Fi(r,this.combinedEnv))}});import{relative as yh,resolve as sl}from"path";var Zr,ol,al=y(()=>{Zr=$(z(),1);k();Et();Pe();ol=async({indexFilePath:t="",withMessaging:e=!1,withMainWorldScript:r=!1},n)=>{d("Creating BGSW entry");let i=sl(n.commonPath.staticDirectory,"background"),s=sl(i,"index.ts"),o=yh(i,t),a=[e&&'import "./messaging"',t&&`import "${ce(o).slice(0,-3)}"`,r&&'import "./main-world-scripts"'].filter(Boolean).join(`
 `);await(0,Zr.ensureDir)(i),await(0,Zr.outputFile)(s,a)}});import{relative as _h,resolve as wh}from"path";import{camelCase as cl}from"change-case";var ll,fl,ul=y(()=>{ll=$(z(),1);k();Et();Pe();fl=async t=>{try{let e=wh(t.commonPath.staticDirectory,"background","main-world-scripts.ts"),r=t.mainWorldScriptList.map(i=>{let s=i.js.map(c=>{let u=cl(c),p=`url:${ce(_h(t.commonPath.entryManifestPath,c))}`;return{importName:u,importPath:p}}),o=s.map(c=>`import ${c.importName} from "${c.importPath}"`).join(`
 `),a=s.map(c=>c.importName),l=Object.entries(i).reduce((c,[u,p])=>(u!=="js"&&(c[cl(u)]=p),c),{id:a.join("-"),js:[]}),f=JSON.stringify(l).replace(/"js":\[\]/,`"js":[${a.map(c=>`${c}.split("/").pop().split("?")[0]`).join(",")}]`);return[o,f]});if(r.length===0)return!1;t.permissionSet.add("scripting");let n=`${r.map(([i])=>i).join(`
 `)}
